\begin{tutorial}{Stirling Number}

\newcommand{\stirling}[2]{\genfrac{[}{]}{0pt}{}{#1}{#2}}

Let us calculate the value of $(\sum_{k=0}^{m} \stirling{n}{k})\bmod p$.

Consider the proof of Lucas' theorem:

$$
\binom{n^\prime p + n_0}{k^\prime p + k_0} \equiv \binom{n^\prime}{k^\prime} \binom{n_0}{k_0} \pmod p
$$

Using $(x+1)^{n^\prime p + n_0}=(x+1)^{n^\prime p }(x+1)^{n_0}$, $(x+1)^p \equiv = x^p + 1 \pmod p$ and binomial expansion, we can easily prove the Lucas' theorem.

Now, is well known that the coefficients of $s_n(x)=x(x+1)(x+2) \ldots (x+n-1)$ are $\stirling{n}{0}, \stirling{n}{1}, \ldots, \stirling{n}{n}$.

We can find that $s_p(x) \equiv x^p - x \pmod p$.

Let $n = n^\prime p + n_0$, and then

$$
\begin{aligned}
s_n(x) &= \prod_{t=0}^{n^\prime-1}(x+tp)(x+tp+1) \ldots (x+tp+p-1) \cdot \prod_{r=0}^{n_0-1}(x+n^\prime p + r)\\
&\equiv \prod_{t=0}^{n^\prime-1}x(x+1) \ldots (x+p-1) \cdot \prod_{r=0}^{n_0-1}(x + r) \equiv s_p^{n^\prime}(x)s_{n_0}(x) \\
&\equiv(x^p-x)^{n^\prime}s_{n_0}(x) \pmod p
\end{aligned}
$$

Using the binomial expansion, we have:

$$
\stirling{n}{k} \equiv (-1)^{n^\prime - j}\binom{n^\prime}{j}\stirling{n_0}{i} \pmod p
$$

where $k=n^\prime+j(p-1)+i$, and $0 \le i < p-1$ if $n_0 = 0$ or $0 < i \le p-1$ if $n_0 > 0$.

After enumerating $i$, we only need to find the value of:

$$
\sum_{j=0}^{\lfloor \frac{m-i-n^\prime}{p-1}\rfloor}(-1)^{n^\prime-j}\binom{n^\prime}{j}
$$

We can rephrase it as: given $n$, $m$, and $x$, find the value of $\sum\limits_{i=0}^{m}\binom{n}{i}x^i$.

Notice that we can use a process like Lucas' theorem to divide $x^n$: $x^n\equiv x^{\lfloor\frac{n}{p}\rfloor} \cdot x^{n \bmod p} \pmod p$. So $x^i$ and $\binom{n}{i}$ can be divided together using the Lucas' theorem.

After that we have:

$$
\sum\limits_{i=0}^{m}\binom{n}{i}x^i=\sum_{t=0}^{\lfloor\frac{m}{p}\rfloor-1}\binom{\lfloor\frac{n}{p}\rfloor}{t}x^t \cdot \sum_{r=0}^{p-1}\binom{n \bmod p}{r}x^r+\binom{n \mathbin{\mathrm{div}} p}{m \mathbin{\mathrm{div}} p} \cdot x^{m \mathbin{\,\mathrm{div}\,} p} \cdot \sum_{r=0}^{m \bmod p}\binom{n \bmod p}{r}x^r
$$

Since $n$ is a given number, there are only $O(\log n)$ different values of $n \bmod p$. We can precalculate the prefix sum of $\binom{n \bmod p}{r} x^r$ for each distinct $n \bmod p$.

Or just use the following formula to speed up:

$$
\sum_{k=0}^{m}(-1)^k \binom{s}{k}=(-1)^m \binom{s-1}{m}
$$

After that, we can use divide and conquer to find the coefficients of $s_{n_0}(x)$ in $O(n_0 \log n_0)$ time.

The total time complexity will be $O(p \log p)$.

\end{tutorial}
