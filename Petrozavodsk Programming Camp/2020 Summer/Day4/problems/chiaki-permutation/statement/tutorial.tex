\begin{tutorial}{Permutation}

We try to find the number of permutations that contain no arithmetic progression of length at least $3$.

For small $n$ ($n \le 20$), we have a very simple dynamic programming solution. Let $\mathit{dp}(x,S)$ be the number of ways such that the first $x$ numbers are filled and the set of numbers used is $S$. We can simply enumerate an $i \not \in S$ such that there is no pair of $(j,k)$ where $j \in S$, $k \not \in S$ and $2i=j+k$. And transfer from $\mathit{dp}(x,S)$ to $\mathit{dp}(x+1,S \cup \{i\})$. The time complexity is $O(2^n \cdot n^2)$.

For large $n$, the restriction is actually very strong and the number of valid states $S$ for each $x$ is very small. When $n=50$, the number of states is roughly $10^6$. We can use hash map or just sorted vector to maintain the value. The time complexity is $O(n^2 \cdot |S|)$.

We can also use some bitwise operations to eliminate the factor $n$ in time complexity. For each $i$, we only need to find some $j$ and $k$ such that $k=2i-j$. If we store $S$ in unsigned $64$-bit integer, swap the high and low $32$ bits of $S$, we can get the representation of $-j$. And with some bitwise shift operations, we can get all valid $k$. After that we can check if some $i$ is valid in $O(1)$.

\end{tutorial}
